// # Terminal 1 - start bpftrace first
// sudo bpftrace --unsafe test.bt

// # Terminal 2 - trigger via wrapper
// cd /mnt/linuxstorage/openssl && /home/lizeren/Desktop/msr_trace/callchain/uprobe/run_openssl.sh

uprobe:/mnt/linuxstorage/openssl/libssl.so:0x4bb0d
{
  printf("=== HIT SSL_select_next_proto pid=%d tid=%d comm=%s ===\n", pid, tid, comm);
 // Freeze the process so /proc/<pid>/... stays valid
  system("kill -STOP %d 2>/dev/null", pid);

  // Dump context while it's stopped
  system("readlink /proc/%d/exe > /tmp/exe.%d 2>/dev/null", pid, pid);
  system("cat /proc/%d/maps > /tmp/maps.%d 2>/dev/null", pid, pid);

  // Optional: confirm file sizes (helps debug if still empty)
  system("wc -c /tmp/exe.%d /tmp/maps.%d 2>/dev/null", pid, pid);

  // Let it run again
  system("kill -CONT %d 2>/dev/null", pid);

  // Print raw stack for offline symbolization
  print(ustack(30));

  // Remove exit() if you want to keep capturing more hits
  exit();
}

